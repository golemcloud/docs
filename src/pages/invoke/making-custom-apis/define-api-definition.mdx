## Define an API definition

To begin with, let's build an API over the functions in the shopping cart component

Let's create a shopping cart component first, and then later add the API definition to it.

### Create a new component

```shell
golem app new
```

Please follow the instructions in the interactive shell. Here is the example


```shell
Selected profile: local
> Application name: shopping-cart
> Select language for the new component Rust
> Select a template for the new component: minimal: Minimal component template for Rust with no dependencies
> Component Package Name: amazon:shopping-cart
> Add another component or create application? Create application
```

Make sure to start the golem server by doing the following.
Use `--clean` if you want a complete clean environment

```shell
golem server run --clean

```

Before we start building the API definition, make sure to replace the contents of
shopping-cart/components-rust/amazon-shopping-cart/wit/amazon-shopping-cart.wit with the following

```wit
package amazon:shopping-cart;

interface api {

  record product-item {
    product-id: string,
    name: string,
    price: f32,
    quantity: u32,
  }

  record order {
    order-id: string,
    items: list<product-item>,
    total: f32,
    timestamp: u64,
  }

  record order-confirmation {
    order-id: string,
  }

  variant checkout-result {
    error(string),
    success(order-confirmation),
  }

  initialize-cart: func(user-id: string);

  add-item: func(item: product-item);

  remove-item: func(product-id: string);

  update-item-quantity: func(product-id: string, quantity: u32);

  checkout: func() -> checkout-result;

  get-cart-contents: func() -> list<product-item>;

  force-commit: func(count: u8);
}

world shopping-cart {
  import golem:api/host@1.1.6;

  export api;
}
```

### Implement the interface

Try to build the component

```shell
cd shopping-cart
golem app build
```

This should give you a compile time error, and that's because you haven't implemented the interface yet.
The implementation details doesn't matter.


Once you fix the compilation errors, test the invocations using golem REPL

### Test the invocations
```shell
cd shopping-cart
golem repl
```

If by any chance you have multiple components in the context, interactive shell would allow you to select
a specific component and will be automatically deployed to the server.


Here is an example usage of REPL. Please take advantage of the auto-completes using `tab` key.

More documentation on the REPL can be found [here](/rib).

```shell
>>> let worker = instance("worker")
()

>>> worker.add-item({product-id: "foo", name: "foo", price: 42, quantity: 42})
()

>>> worker.add-item({product-id: "foo", name: "foo", price: 42, quantity: 42})
()

>>> worker.get-cart-contents()
[{product-id: "foo", name: "foo", price: 42, quantity: 42}, {product-id: "foo", name: "foo", price: 42, quantity: 42}]

>>> worker.checkout()
success({order-id: "238738674"})
```

REPL is a great way to test the component and its functions, h
however note that it's a brand new feature and is experimental in nature.


### Configure API definitions

We can configure the API definition by updating the `golem.yaml` file (`shopping-cart/components-rust/amazon-shopping-cart/golem.yaml`)
Here is an updated version of the golem.yaml that has the API definition (the routes and the implementation using Rib),
as well as the API deployment that specify the details of the server to which the requests should be routed. Since this example is making using of golem OSS,
the only valid value is `http://localhost:9006/v1` because that's where the API gateway is running when you run the golem server.

```yaml
# Schema for IDEA:
# $schema: https://schema.golem.cloud/app/golem/1.2.2-dev.1/golem.schema.json
# Schema for vscode-yaml
# yaml-language-server: $schema=https://schema.golem.cloud/app/golem/1.2.2-dev.1/golem.schema.json

# See https://learn.golem.cloud/docs/app-manifest#field-reference for field reference

components:
  amazon:shopping-cart:
    template: rust

httpApi:
  definitions:
    shopping-cart:
      version: '0.0.1'
      routes:
        - method: POST
          path: /v1/{user}/add-to-cart
          binding:
            type: default
            componentName: "amazon:shopping-cart"
            response: |
              let user: string = request.path.user;
              let worker = instance("cart-${user}");
              worker.add-item(request.body.item);
              {status: 200, message: "successfully added item"}


  deployments:
    local:
    - host: localhost:9006
      definitions:
       - shopping-cart
```

### Deploy and Test the API

```shell
golem api deploy
```



We will add more routes and redeploy the API definition later

Please use this as a reference instead of using it with zero changes. For example, you might need to give a different
version, component etc (explained below). You can get the `component` details including `name` and `version`
by running `golem component list` command.

The API definition's fields have the following meaning:

| Field     | Description                                                                                                                                                                                                                                                           |
| --------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `id`      | This field represents the unique identifier for the API definition. In this case, it is set to "shopping-cart-v1".                                                                                                                                                    |
| `version` | This field indicates the version of the API definition. Here, it is set to "0.0.3".                                                                                                                                                                                   |
| `routes`  | This field contains an array of route objects, each representing a specific endpoint definition.                                                                                                                                                                      |
| `method`  | Indicates the HTTP method associated with the route. In this example, it is set to "Get", indicating that this route handles GET requests.                                                                                                                            |
| `path`    | Specifies the URL path pattern for the route. It may include path parameters enclosed in curly braces. Here, the path is `/{user-id}/get-cart-contents`, indicating that this route handles requests to retrieve the contents of a shopping cart for a specific user. |
| `binding` | This object contains information about how the request should be handled by the Golem worker.                                                                                                                                                                         |

### Golem Binding

Let's break down the binding object.

| Field         | Description                                                                                                                                                                                                                                                                                                                                                                                      |
| ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `type`        | Specifies the type of binding. Here, it is set to "default", indicating that the binding involves a Golem worker.                                                                                                                                                                                                                                                                             |
| `component`   | Specifies the component's name and version                                                                                                                                                                                                                                                                                          |
| `response`    | The `response` field here is a Rib expression that allows you to call any worker function and manipulates its output.                                                                                                                                                                                                                                                                            |

See the [binding type reference](/http-api-definitions/worker-binding-types) for more details on the supported binding types.

If your worker name is a constant, the you can simply make it a constant string such as `"foo"`. Please note that it has to be quoted for it a valid Rib string.
See the [Rib reference](/rib) for the full reference of the binding language.


### Ephemeral and Durable worker invocation

The worker can be ephemeral or durable depending on whether you passed the worker-name argument into the `instance` function. You can find more details about the `instance` function in the [Rib reference](/rib).

In this example, the following Rib expression defines the request:

```
let user: u64 = request.path.user-id;
let worker = instance(my-worker-${user});
let result = worker.get-cart-contents();
{status: 200, body: result}

```

The first line is about extracting the `user-id` from the path and assigning it to the variable `user`.
Similarly you can extract the query parameters, headers and body from the request object.
The `request` object is a Rib record that contains all the information about the HTTP request.
Please find more information about the `request` object in the [Rib reference](/rib#http-request-input-and-field-selection).

The second line is about creating a worker instance with the name `my-worker-${user}`.
The third line is about calling the function `get-cart-contents`  in the component, and it will be invoked  against the worker `my-worker-${user}`.
Note that the real fully qualified function name (the one that is listed in component metadata is `golem:it/api.{get-cart-contents}`) however,
you can should use the shorter `get-cart-contents` as shown in the example. Please find more details about the `instance` function in the [Rib reference](/rib).

The third line assigns the result of the worker function to the variable `result`. The last line is a WASM record where you are mapping to the response. Here body is `result` itself.
That means, we are not manipulating the result returned by the function, and simply forward it as response body. Status is 200. Sometimes you need to specify the type of such as `200: u64`
to help out with the compiler

### Getting Data from an HTTP Request in Rib

The `request` object is a record that contains all the information about the HTTP request.
This object is automatically passed to the Rib script through gateway when an API is invoked.
You can find more details about the `request` object in the [Rib documentation](/rib#http-request-input-and-field-selection),
which covers how to look up the path, query, header and body parameters in a Http Request using Rib.

### Getting Started with Rib
Please see the [Rib reference](/rib) to know more about Rib language.
